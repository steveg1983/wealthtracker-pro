<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TrueLayer Direct Test</title>
    <style>
        body { font-family: Arial; padding: 20px; max-width: 800px; margin: 0 auto; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; background: #0066cc; color: white; border: none; border-radius: 5px; margin: 5px; }
        button:hover { background: #0052a3; }
        pre { background: #f4f4f4; padding: 15px; border-radius: 5px; overflow-x: auto; font-size: 12px; }
        .success { color: green; }
        .error { color: red; }
        .info { background: #e7f3ff; padding: 15px; border-left: 4px solid #0066cc; margin: 20px 0; }
        input { padding: 8px; width: 100%; margin: 5px 0; box-sizing: border-box; }
        label { font-weight: bold; display: block; margin-top: 10px; }
    </style>
</head>
<body>
    <h1>üè¶ TrueLayer Direct Auth Test</h1>

    <div class="info">
        <strong>This page helps debug TrueLayer auth issues by building URLs directly in the browser.</strong>
    </div>

    <h2>Configuration</h2>
    <label>Client ID:</label>
    <input type="text" id="clientId" value="sandbox-wealthtracker-dd0b41" />

    <label>Redirect URI:</label>
    <input type="text" id="redirectUri" value="http://localhost:5173/test-truelayer-direct.html" />

    <label>Scopes (space-separated):</label>
    <input type="text" id="scopes" value="info accounts balance transactions offline_access" />

    <label>API Base URL (for token exchange):</label>
    <input type="text" id="apiBaseUrl" value="https://wealthtracker-pro-git-claude-lint-cleanup-steven-greens-projects.vercel.app" />
    <button onclick="testApiConnection()">üîç Test API Connection</button>
    <div id="apiTestResult"></div>

    <h2>Test Different Auth URL Formats</h2>

    <button onclick="testMinimalUrl()">Test Minimal URL</button>
    <button onclick="testSuperMinimal()">Test Super Minimal (no nonce, no offline_access)</button>
    <button onclick="testDirectMock()">Test Direct Mock Bank (skip provider selection)</button>
    <button onclick="testWithResponseMode()">Test with response_mode=query</button>
    <button onclick="testWithFormPost()">Test with response_mode=form_post</button>
    <button onclick="testWithProviders()">Test with provider filters</button>

    <div id="result"></div>

    <h2>Callback Result</h2>
    <div id="callbackResult"></div>

    <script>
        function generateState() {
            return btoa(JSON.stringify({
                userId: 'test-user-direct',
                issuedAt: Date.now(),
                nonce: Math.random().toString(36).substring(7)
            }));
        }

        function testMinimalUrl() {
            const clientId = document.getElementById('clientId').value;
            const redirectUri = document.getElementById('redirectUri').value;
            const scopes = document.getElementById('scopes').value;
            const state = generateState();
            const nonce = Math.random().toString(36).substring(7);

            const url = new URL('https://auth.truelayer-sandbox.com/');
            url.searchParams.set('response_type', 'code');
            url.searchParams.set('client_id', clientId);
            url.searchParams.set('redirect_uri', redirectUri);
            url.searchParams.set('scope', scopes);
            url.searchParams.set('state', state);
            url.searchParams.set('nonce', nonce);

            showResult('Minimal URL (just required params)', url);
        }

        function testSuperMinimal() {
            const clientId = document.getElementById('clientId').value;
            const redirectUri = document.getElementById('redirectUri').value;
            const state = generateState();

            const url = new URL('https://auth.truelayer-sandbox.com/');
            url.searchParams.set('response_type', 'code');
            url.searchParams.set('client_id', clientId);
            url.searchParams.set('redirect_uri', redirectUri);
            url.searchParams.set('scope', 'info accounts balance transactions'); // No offline_access
            url.searchParams.set('state', state);
            url.searchParams.set('providers', 'mock'); // CRITICAL: Required by TrueLayer

            showResult('Super Minimal + providers=mock (bare minimum that works)', url);
        }

        function testDirectMock() {
            const clientId = document.getElementById('clientId').value;
            const redirectUri = document.getElementById('redirectUri').value;
            const state = generateState();
            const nonce = Math.random().toString(36).substring(7);

            const url = new URL('https://auth.truelayer-sandbox.com/');
            url.searchParams.set('response_type', 'code');
            url.searchParams.set('response_mode', 'query');
            url.searchParams.set('client_id', clientId);
            url.searchParams.set('redirect_uri', redirectUri);
            url.searchParams.set('scope', 'info accounts balance transactions offline_access');
            url.searchParams.set('state', state);
            url.searchParams.set('nonce', nonce);
            url.searchParams.set('provider_id', 'mock'); // Direct to mock provider
            url.searchParams.set('enable_mock', 'true');

            showResult('Direct Mock Bank (provider_id=mock, skips selection)', url);
        }

        function testWithResponseMode() {
            const clientId = document.getElementById('clientId').value;
            const redirectUri = document.getElementById('redirectUri').value;
            const scopes = document.getElementById('scopes').value;
            const state = generateState();
            const nonce = Math.random().toString(36).substring(7);

            const url = new URL('https://auth.truelayer-sandbox.com/');
            url.searchParams.set('response_type', 'code');
            url.searchParams.set('response_mode', 'query');
            url.searchParams.set('client_id', clientId);
            url.searchParams.set('redirect_uri', redirectUri);
            url.searchParams.set('scope', scopes);
            url.searchParams.set('state', state);
            url.searchParams.set('nonce', nonce);
            url.searchParams.set('enable_mock', 'true');

            showResult('With response_mode=query + enable_mock', url);
        }

        function testWithFormPost() {
            const clientId = document.getElementById('clientId').value;
            const redirectUri = document.getElementById('redirectUri').value;
            const scopes = document.getElementById('scopes').value;
            const state = generateState();
            const nonce = Math.random().toString(36).substring(7);

            const url = new URL('https://auth.truelayer-sandbox.com/');
            url.searchParams.set('response_type', 'code');
            url.searchParams.set('response_mode', 'form_post');
            url.searchParams.set('client_id', clientId);
            url.searchParams.set('redirect_uri', redirectUri);
            url.searchParams.set('scope', scopes);
            url.searchParams.set('state', state);
            url.searchParams.set('nonce', nonce);
            url.searchParams.set('enable_mock', 'true');

            showResult('With response_mode=form_post + enable_mock', url);
        }

        function testWithProviders() {
            const clientId = document.getElementById('clientId').value;
            const redirectUri = document.getElementById('redirectUri').value;
            const scopes = document.getElementById('scopes').value;
            const state = generateState();
            const nonce = Math.random().toString(36).substring(7);

            const url = new URL('https://auth.truelayer-sandbox.com/');
            url.searchParams.set('response_type', 'code');
            url.searchParams.set('response_mode', 'query');
            url.searchParams.set('client_id', clientId);
            url.searchParams.set('redirect_uri', redirectUri);
            url.searchParams.set('scope', scopes);
            url.searchParams.set('state', state);
            url.searchParams.set('nonce', nonce);
            url.searchParams.set('enable_mock', 'true');
            url.searchParams.set('enable_open_banking_providers', 'true');
            url.searchParams.set('enable_oauth_providers', 'true');

            showResult('With all provider flags', url);
        }

        function showResult(title, url) {
            const result = document.getElementById('result');
            result.innerHTML = `
                <h3>${title}</h3>
                <p><strong>Full URL:</strong></p>
                <pre>${url.toString()}</pre>
                <p><strong>Parameters:</strong></p>
                <ul>
                    ${Array.from(url.searchParams.entries()).map(([k, v]) => `<li><strong>${k}:</strong> ${v}</li>`).join('')}
                </ul>
                <button onclick="window.location.href='${url.toString()}'">üöÄ Try This URL</button>
                <hr>
            `;
        }

        // Handle callback
        const urlParams = new URLSearchParams(window.location.search);
        const callbackDiv = document.getElementById('callbackResult');

        if (urlParams.has('code')) {
            callbackDiv.innerHTML = `
                <p class="success">‚úÖ Success! Got authorization code:</p>
                <pre>${urlParams.get('code')}</pre>
                <p><strong>State:</strong></p>
                <pre>${urlParams.get('state')}</pre>
                <p class="success">üéâ The OAuth flow worked! You can now exchange this code for tokens.</p>
                <button onclick="exchangeToken()">üîÑ Exchange Code for Access Token</button>
                <div id="tokenResult"></div>
            `;
        } else if (urlParams.has('error')) {
            callbackDiv.innerHTML = `
                <p class="error">‚ùå OAuth Error:</p>
                <p><strong>Error:</strong> ${urlParams.get('error')}</p>
                <p><strong>Description:</strong> ${urlParams.get('error_description')}</p>
            `;
        }

        async function testApiConnection() {
            const baseUrl = document.getElementById('apiBaseUrl').value;
            const result = document.getElementById('apiTestResult');
            result.innerHTML = '<p>Testing API connection...</p>';

            try {
                const response = await fetch(`${baseUrl}/api/banking/health`);
                const data = await response.json();

                if (data.status === 'ok') {
                    result.innerHTML = `
                        <p class="success">‚úÖ API Connected!</p>
                        <p><strong>Environment:</strong> ${data.env_check.environment}</p>
                        <p><strong>Has Client ID:</strong> ${data.env_check.has_truelayer_client_id ? '‚úÖ' : '‚ùå'}</p>
                        <p><strong>Has Secret:</strong> ${data.env_check.has_truelayer_secret ? '‚úÖ' : '‚ùå'}</p>
                        <p><strong>Redirect URI:</strong> ${data.env_check.redirect_uri || 'Not set'}</p>
                    `;
                } else {
                    result.innerHTML = `<p class="error">‚ùå API test failed: ${JSON.stringify(data)}</p>`;
                }
            } catch (error) {
                result.innerHTML = `<p class="error">‚ùå Cannot connect to API: ${error.message}</p>`;
            }
        }

        async function exchangeToken() {
            const code = urlParams.get('code');
            const state = urlParams.get('state');
            const result = document.getElementById('tokenResult');
            const baseUrl = document.getElementById('apiBaseUrl').value;

            result.innerHTML = `<p>Exchanging code for access token using ${baseUrl.split('//')[1].split('.')[0]}...</p>`;

            try {
                const response = await fetch(`${baseUrl}/api/banking/exchange-token`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code, state })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    result.innerHTML = `
                        <p class="success">‚úÖ Token Exchange Successful!</p>
                        <p><strong>Connection ID:</strong> ${data.connectionId}</p>
                        <p><strong>Institution:</strong> ${data.institutionName} (${data.institutionId})</p>
                        <p><strong>Accounts Found:</strong> ${data.accountsCount}</p>
                        ${data.institutionLogo ? `<p><img src="${data.institutionLogo}" alt="Bank logo" style="max-width: 100px;"></p>` : ''}
                        <p class="success">üéâ Full OAuth flow complete! Bank connection saved to database.</p>
                    `;
                } else {
                    result.innerHTML = `
                        <p class="error">‚ùå Token exchange failed</p>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                        <p>Try testing the API connection first with the button above.</p>
                        <button onclick="exchangeToken()">üîÑ Retry</button>
                    `;
                }
            } catch (error) {
                result.innerHTML = `
                    <p class="error">‚ùå Error: ${error.message}</p>
                    <p>Make sure the API Base URL is correct and the deployment has CORS enabled.</p>
                    <button onclick="exchangeToken()">üîÑ Retry</button>
                `;
            }
        }
    </script>
</body>
</html>
