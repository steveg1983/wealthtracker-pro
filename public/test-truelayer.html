<!DOCTYPE html>
<html>
<head>
    <title>TrueLayer Local Test</title>
    <style>
        body { font-family: Arial; padding: 20px; max-width: 800px; margin: 0 auto; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; background: #0066cc; color: white; border: none; border-radius: 5px; }
        button:hover { background: #0052a3; }
        pre { background: #f4f4f4; padding: 15px; border-radius: 5px; overflow-x: auto; }
        .success { color: green; }
        .error { color: red; }
        .info { background: #e7f3ff; padding: 15px; border-left: 4px solid #0066cc; margin: 20px 0; }
    </style>
</head>
<body>
    <h1>üè¶ TrueLayer OAuth Test - Local</h1>

    <div class="info">
        <strong>Before starting:</strong> Make sure you've added <code>http://localhost:5173/test-truelayer.html</code> to your TrueLayer redirect URIs in the console.
    </div>

    <h2>Step 1: Get Auth URL</h2>
    <button onclick="getAuthUrl()">Generate Auth URL</button>
    <div id="authUrlResult"></div>

    <h2>Step 2: Complete the flow</h2>
    <p>After clicking "Start OAuth Flow", you'll be redirected to TrueLayer to authorize. Complete the authorization and you'll be redirected back here.</p>

    <h2>Step 3: Result</h2>
    <div id="callbackResult"></div>

    <script>
        async function getAuthUrl() {
            const result = document.getElementById('authUrlResult');
            result.innerHTML = '<p>Loading...</p>';

            try {
                // Call the production API endpoint (Vercel deployment)
                const response = await fetch('https://wealthtracker-pro-git-claude-lint-30c58d-steven-greens-projects.vercel.app/api/banking/create-link-token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: 'test-user-local-123' })
                });

                const data = await response.json();

                if (data.authUrl) {
                    // Update the redirect URI to point back to this test page
                    const url = new URL(data.authUrl);
                    url.searchParams.set('redirect_uri', 'http://localhost:5173/test-truelayer.html');

                    result.innerHTML = `
                        <p class="success">‚úÖ Auth URL Generated!</p>
                        <p><strong>Client ID:</strong> ${url.searchParams.get('client_id')}</p>
                        <p><strong>Redirect URI:</strong> ${url.searchParams.get('redirect_uri')}</p>
                        <p><strong>Environment:</strong> ${url.hostname.includes('sandbox') ? 'Sandbox' : 'Production'}</p>
                        <details>
                            <summary>Full Auth URL</summary>
                            <pre>${url.toString()}</pre>
                        </details>
                        <br>
                        <button onclick="window.location.href='${url.toString()}'">üöÄ Start OAuth Flow</button>
                    `;
                } else {
                    result.innerHTML = `<p class="error">‚ùå Error: ${JSON.stringify(data, null, 2)}</p>`;
                }
            } catch (error) {
                result.innerHTML = `<p class="error">‚ùå Error: ${error.message}</p>`;
            }
        }

        // Handle callback when redirected back from TrueLayer
        const urlParams = new URLSearchParams(window.location.search);
        const callbackDiv = document.getElementById('callbackResult');

        if (urlParams.has('code')) {
            callbackDiv.innerHTML = `
                <p class="success">‚úÖ OAuth Authorization Successful!</p>
                <p><strong>Authorization Code:</strong></p>
                <pre>${urlParams.get('code')}</pre>
                <p><strong>State:</strong></p>
                <pre>${urlParams.get('state')}</pre>
                <p class="success">üéâ The OAuth flow worked! TrueLayer redirected back successfully.</p>
                <button onclick="testExchangeToken()">Exchange Code for Token</button>
                <div id="tokenResult"></div>
            `;
        } else if (urlParams.has('error')) {
            callbackDiv.innerHTML = `
                <p class="error">‚ùå OAuth Error:</p>
                <p><strong>Error:</strong> ${urlParams.get('error')}</p>
                <p><strong>Description:</strong> ${urlParams.get('error_description')}</p>
            `;
        }

        async function testExchangeToken() {
            const code = new URLSearchParams(window.location.search).get('code');
            const state = new URLSearchParams(window.location.search).get('state');
            const result = document.getElementById('tokenResult');
            result.innerHTML = '<p>Exchanging code for token...</p>';

            try {
                const response = await fetch('https://wealthtracker-pro-git-claude-lint-30c58d-steven-greens-projects.vercel.app/api/banking/exchange-token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code, state })
                });

                const data = await response.json();

                if (response.ok && data.access_token) {
                    result.innerHTML = `
                        <p class="success">‚úÖ Token Exchange Successful!</p>
                        <p><strong>Access Token:</strong> ${data.access_token.substring(0, 20)}...</p>
                        ${data.refresh_token ? `<p><strong>Refresh Token:</strong> ${data.refresh_token.substring(0, 20)}...</p>` : ''}
                        <p class="success">üéâ Full OAuth flow complete! You can now fetch bank accounts.</p>
                    `;
                } else {
                    result.innerHTML = `<p class="error">‚ùå Token exchange failed: ${JSON.stringify(data, null, 2)}</p>`;
                }
            } catch (error) {
                result.innerHTML = `<p class="error">‚ùå Error: ${error.message}</p>`;
            }
        }
    </script>
</body>
</html>
