import{ce as e}from"./index-CgJz7Gw0.js";import"./chunk-BWx9oMeS.js";import"./chunk-BN8kgYrt.js";import"./chunk-C1eKK5Oc.js";const t=new class{tokenKey="wt_csrf_token";tokenExpiry=864e5;tokenHeader="X-CSRF-Token";tokenField="_csrf";generateToken(){const t=Date.now(),n=e.lib.WordArray.random(16),r=e.SHA256(`${t}-${n}`).toString(),o={token:r,expiry:t+this.tokenExpiry,timestamp:t};return sessionStorage.setItem(this.tokenKey,JSON.stringify(o)),r}getToken(){const e=sessionStorage.getItem(this.tokenKey);if(!e)return this.generateToken();try{const t=JSON.parse(e);return Date.now()>t.expiry?this.generateToken():t.token}catch{return this.generateToken()}}validateToken(e){if(!e)return!1;const t=sessionStorage.getItem(this.tokenKey);if(!t)return!1;try{const n=JSON.parse(t);return!(Date.now()>n.expiry)&&this.constantTimeCompare(e,n.token)}catch{return!1}}constantTimeCompare(e,t){if(e.length!==t.length)return!1;let n=0;for(let r=0;r<e.length;r++)n|=e.charCodeAt(r)^t.charCodeAt(r);return 0===n}addTokenToHeaders(e={}){const t=this.getToken();return e instanceof Headers?e.set(this.tokenHeader,t):Array.isArray(e)?e.push([this.tokenHeader,t]):e[this.tokenHeader]=t,e}addTokenToFormData(e){const t=this.getToken();return e.append(this.tokenField,t),e}createTokenInput(){const e=document.createElement("input");return e.type="hidden",e.name=this.tokenField,e.value=this.getToken(),e}useCSRFToken(){return{token:this.getToken(),tokenHeader:this.tokenHeader,tokenField:this.tokenField,addToHeaders:this.addTokenToHeaders.bind(this),addToFormData:this.addTokenToFormData.bind(this),validate:this.validateToken.bind(this)}}fetchWithCSRF(e,t={}){const n="string"==typeof e?e:e.toString();if(!n.startsWith("/")&&!n.startsWith(window.location.origin))return fetch(e,t);const r=t.method?.toUpperCase()||"GET";return["POST","PUT","DELETE","PATCH"].includes(r)&&(t.headers=this.addTokenToHeaders(t.headers)),fetch(e,t)}createAxiosInterceptor(){return{request:e=>{if(e.url&&!e.url.startsWith("/")&&!e.url.startsWith(window.location.origin))return e;const t=e.method?.toUpperCase()||"GET";return["POST","PUT","DELETE","PATCH"].includes(t)&&(e.headers=e.headers||{},e.headers[this.tokenHeader]=this.getToken()),e}}}expressMiddleware(){return(e,t,n)=>{if(["GET","HEAD","OPTIONS"].includes(e.method))return n();const r=e.headers[this.tokenHeader.toLowerCase()]||e.body?.[this.tokenField];if(!this.validateToken(r))return t.status(403).json({error:"Invalid CSRF token"});n()}}clearToken(){sessionStorage.removeItem(this.tokenKey)}},n=()=>t.getToken();t.fetchWithCSRF.bind(t);const r=()=>{"undefined"!=typeof document&&document.addEventListener("submit",e=>{const n=e.target;if(n.querySelector('input[name="_csrf"]'))return;if("GET"===n.method.toUpperCase())return;const r=t.createTokenInput();n.appendChild(r)})},o=()=>{const e=n();document.cookie=`csrf_token=${e}; path=/; SameSite=Strict`};export{t as csrfProtection,t as default,n as getCSRFToken,r as setupCSRFForForms,o as setupDoubleSubmitCookie};
