const e=new class{limits=new Map;cleanupInterval=null;constructor(){this.startCleanup()}createLimiter(e,t){const{maxRequests:s,windowMs:i,keyGenerator:a=()=>"global",skipSuccessfulRequests:n=!1,skipFailedRequests:r=!1}=t;return{check:t=>{const n=a(t),r=Date.now();this.limits.has(e)||this.limits.set(e,new Map);const o=this.limits.get(e);let c=o.get(n);(!c||r>c.resetTime)&&(c={count:0,resetTime:r+i,firstRequest:r},o.set(n,c));const l=Math.max(0,s-c.count);return{allowed:c.count<s,remaining:l,resetTime:c.resetTime}},consume:(t,o=!0)=>{if(o&&n||!o&&r)return!0;const c=a(t),l=Date.now();this.limits.has(e)||this.limits.set(e,new Map);const u=this.limits.get(e);let m=u.get(c);return(!m||l>m.resetTime)&&(m={count:0,resetTime:l+i,firstRequest:l},u.set(c,m)),!!(m.count<s)&&(m.count++,!0)},reset:t=>{const s=a(t),i=this.limits.get(e);i&&i.delete(s)}}}startCleanup(){this.cleanupInterval=window.setInterval(()=>{const e=Date.now();this.limits.forEach(t=>{const s=[];t.forEach((t,i)=>{e>t.resetTime&&s.push(i)}),s.forEach(e=>t.delete(e))})},6e4)}destroy(){null!==this.cleanupInterval&&(clearInterval(this.cleanupInterval),this.cleanupInterval=null)}},t={api:e.createLimiter("api",{maxRequests:100,windowMs:6e4,keyGenerator:()=>"user"}),login:e.createLimiter("login",{maxRequests:5,windowMs:9e5,keyGenerator:e=>e?.email||e?.ip||"global",skipSuccessfulRequests:!0}),createTransaction:e.createLimiter("createTransaction",{maxRequests:30,windowMs:6e4}),bulkOperation:e.createLimiter("bulkOperation",{maxRequests:10,windowMs:3e5}),export:e.createLimiter("export",{maxRequests:20,windowMs:36e5}),search:e.createLimiter("search",{maxRequests:60,windowMs:6e4}),upload:e.createLimiter("upload",{maxRequests:50,windowMs:36e5,keyGenerator:e=>e?.fileType||"global"})},s=()=>{const e=window.fetch;window.fetch=async function(...s){const[i]=s;if("string"==typeof i&&(i.startsWith("/api/")||i.includes("/api/")&&!i.includes("localhost:3000")&&!i.includes("supabase")&&!i.includes("stripe"))){const e=t.api.check();if(!e.allowed)throw new Error(`API rate limit exceeded. ${e.remaining} requests remaining. Reset at ${new Date(e.resetTime).toLocaleTimeString()}`);t.api.consume()}return e.apply(this,s)}};export{e as default,s as initializeRateLimiter,t as rateLimiters};
