const e=new class{rules=[];constructor(){this.loadRules()}loadRules(){try{const e=localStorage.getItem("wealthtracker_import_rules");e&&(this.rules=JSON.parse(e))}catch(e){console.error("Error loading import rules:",e),this.rules=[]}}saveRules(){localStorage.setItem("wealthtracker_import_rules",JSON.stringify(this.rules))}getRules(){return[...this.rules].sort((e,t)=>e.priority-t.priority)}getRule(e){return this.rules.find(t=>t.id===e)}addRule(e){const t={...e,id:Date.now().toString(),createdAt:new Date,updatedAt:new Date};return this.rules.push(t),this.saveRules(),t}updateRule(e,t){const s=this.rules.findIndex(t=>t.id===e);-1!==s&&(this.rules[s]={...this.rules[s],...t,updatedAt:new Date},this.saveRules())}deleteRule(e){this.rules=this.rules.filter(t=>t.id!==e),this.saveRules()}checkCondition(e,t){let s;switch(e.field){case"description":s=t.description||"";break;case"amount":s=Math.abs(t.amount||0);break;case"accountId":s=t.accountId||"";break;case"date":s=t.date?new Date(t.date):null}if(null==s)return!1;switch(e.operator){case"contains":return"string"==typeof s&&(e.caseSensitive?s.includes(e.value):s.toLowerCase().includes(e.value.toLowerCase()));case"equals":return"amount"===e.field&&"number"==typeof s?Math.abs(s-e.value)<.01:e.caseSensitive?s===e.value:s.toString().toLowerCase()===e.value.toString().toLowerCase();case"startsWith":return"string"==typeof s&&(e.caseSensitive?s.startsWith(e.value):s.toLowerCase().startsWith(e.value.toLowerCase()));case"endsWith":return"string"==typeof s&&(e.caseSensitive?s.endsWith(e.value):s.toLowerCase().endsWith(e.value.toLowerCase()));case"greaterThan":return"number"==typeof s&&s>e.value;case"lessThan":return"number"==typeof s&&s<e.value;case"between":return"number"==typeof s&&s>=e.value&&s<=e.value2;case"regex":if("string"!=typeof s)return!1;try{return new RegExp(e.value,e.caseSensitive?"":"i").test(s)}catch{return!1}default:return!1}}applyAction(e,t){const s={...t};switch(e.type){case"setCategory":e.value&&(s.category=e.value);break;case"addTag":e.value&&(s.tags=s.tags||[],s.tags.includes(e.value)||s.tags.push(e.value));break;case"modifyDescription":if(s.description&&e.modification)switch(e.modification){case"replace":s.description=e.value||"";break;case"prepend":s.description=(e.value||"")+s.description;break;case"append":s.description=s.description+(e.value||"");break;case"regex":if(e.pattern)try{const t=new RegExp(e.pattern,"g");s.description=s.description.replace(t,e.replacement||"")}catch{}}break;case"setAccount":e.value&&(s.accountId=e.value);break;case"skip":s.__skip=!0}return s}applyRules(e){let t={...e};const s=this.rules.filter(e=>e.enabled).sort((e,t)=>e.priority-t.priority);for(const a of s)if(a.conditions.every(e=>this.checkCondition(e,t)))for(const e of a.actions)if(t=this.applyAction(e,t),t.__skip)return null;return delete t.__skip,t}testRule(e,t){const s={description:t.description,amount:t.amount,accountId:t.accountId,date:t.date||new Date};return e.conditions.every(e=>this.checkCondition(e,s))}suggestRules(e){const t=[],s=new Map;return e.forEach(e=>{const t=e.description.toLowerCase().split(/\s+/).slice(0,2).join(" ");if(t.length>3){const a=s.get(t)||{count:0};a.count++,!e.category||a.category&&1!==a.count||(a.category=e.category),s.set(t,a)}}),s.forEach((e,s)=>{e.count>=3&&e.category&&t.push({name:`Auto-categorize "${s}"`,description:`Automatically categorize transactions containing "${s}"`,enabled:!0,priority:t.length+1,conditions:[{field:"description",operator:"contains",value:s,caseSensitive:!1}],actions:[{type:"setCategory",value:e.category}]})}),t.slice(0,10)}};export{e as i};
