import{s as t}from"./chunk-CkYa08k9.js";const e=new class{parseOFX(t){const e=t.indexOf("<OFX>");if(-1===e)throw new Error("Invalid OFX file: <OFX> tag not found");const n=t.substring(e),a=this.parseAccountInfo(n),c=this.parseTransactions(n),s=this.parseBalance(n),r=this.extractValue(n,"<DTSTART>","</DTSTART>")||this.extractValue(n,"<DTSTART>","\n"),i=this.extractValue(n,"<DTEND>","</DTEND>")||this.extractValue(n,"<DTEND>","\n");return{account:a,transactions:c,balance:s,currency:this.extractValue(n,"<CURDEF>","</CURDEF>")||this.extractValue(n,"<CURDEF>","\n")||"GBP",startDate:r?this.parseOFXDate(r):void 0,endDate:i?this.parseOFXDate(i):void 0}}parseAccountInfo(t){let e=this.extractValue(t,"<ACCTID>","</ACCTID>")||this.extractValue(t,"<ACCTID>","\n");if(e||(e=this.extractValue(t,"<ACCTID>","</ACCTID>")||this.extractValue(t,"<ACCTID>","\n")),!e)throw new Error("Account ID not found in OFX file");const n=this.extractValue(t,"<BANKID>","</BANKID>")||this.extractValue(t,"<BANKID>","\n"),a=this.extractValue(t,"<BRANCHID>","</BRANCHID>")||this.extractValue(t,"<BRANCHID>","\n"),c=this.extractValue(t,"<ACCTTYPE>","</ACCTTYPE>")||this.extractValue(t,"<ACCTTYPE>","\n")||"CHECKING";return{bankId:n||void 0,accountId:e.trim(),accountType:c,branchId:a||void 0}}parseTransactions(t){const e=[],n=/<STMTTRN>([\s\S]*?)<\/STMTTRN>/g;let a;for(;null!==(a=n.exec(t));){const t=a[1],n=this.extractValue(t,"<TRNTYPE>","</TRNTYPE>")||this.extractValue(t,"<TRNTYPE>","\n")||"OTHER",c=this.extractValue(t,"<DTPOSTED>","</DTPOSTED>")||this.extractValue(t,"<DTPOSTED>","\n"),s=this.extractValue(t,"<TRNAMT>","</TRNAMT>")||this.extractValue(t,"<TRNAMT>","\n"),r=this.extractValue(t,"<FITID>","</FITID>")||this.extractValue(t,"<FITID>","\n"),i=this.extractValue(t,"<NAME>","</NAME>")||this.extractValue(t,"<NAME>","\n")||"Unknown",u=this.extractValue(t,"<MEMO>","</MEMO>")||this.extractValue(t,"<MEMO>","\n"),o=this.extractValue(t,"<CHECKNUM>","</CHECKNUM>")||this.extractValue(t,"<CHECKNUM>","\n"),l=this.extractValue(t,"<REFNUM>","</REFNUM>")||this.extractValue(t,"<REFNUM>","\n");c&&s&&r&&e.push({type:n,datePosted:this.parseOFXDate(c),amount:parseFloat(s),fitId:r.trim(),name:this.cleanString(i),memo:u?this.cleanString(u):void 0,checkNum:o||void 0,refNum:l||void 0})}return e}parseBalance(t){const e=this.extractValue(t,"<BALAMT>","</BALAMT>")||this.extractValue(t,"<BALAMT>","\n"),n=this.extractValue(t,"<DTASOF>","</DTASOF>")||this.extractValue(t,"<DTASOF>","\n");if(e&&n)return{amount:parseFloat(e),dateAsOf:this.parseOFXDate(n)}}extractValue(t,e,n){const a=t.indexOf(e);if(-1===a)return null;const c=a+e.length,s="\n"===n?t.indexOf("\n",c):t.indexOf(n,c);return-1===s?null:t.substring(c,s).trim()}parseOFXDate(t){const e=t.replace(/\[.*?\]/,"");return`${e.substring(0,4)}-${e.substring(4,6)}-${e.substring(6,8)}`}cleanString(t){return t.replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/&#39;/g,"'").trim()}getTransactionType(t,e){return e>0||["CREDIT","DEP","INT","DIV"].includes(t)?"income":"expense"}findMatchingAccount(t,e){const n=t.accountId.slice(-4);for(const c of e){if(c.name.includes(n)||c.institution&&c.institution.includes(n))return c;if(t.bankId&&c.institution){const e=t.bankId.slice(-6);if(c.institution.includes(e))return c}}const a={CHECKING:"current",SAVINGS:"savings",CREDITCARD:"credit",CREDITLINE:"credit",LOAN:"loan",INVESTMENT:"investment"}[t.accountType];if(a){const t=e.filter(t=>t.type===a);if(1===t.length)return t[0]}return null}async importTransactions(e,n,a,c={}){const s=this.parseOFX(e);let r=null;r=c.accountId?n.find(t=>t.id===c.accountId)||null:this.findMatchingAccount(s.account,n);const i=[];let u=0;for(const o of s.transactions){if(!1!==c.skipDuplicates&&a.some(t=>t.notes&&t.notes.includes(`FITID: ${o.fitId}`))){u++;continue}const e=Math.abs(o.amount),n=this.getTransactionType(o.type,o.amount),s=o.memo||o.name,l=[`FITID: ${o.fitId}`,o.checkNum?`Check #: ${o.checkNum}`:null,o.refNum?`Ref: ${o.refNum}`:null].filter(Boolean).join("\n"),T={date:o.datePosted,description:s,amount:e,type:n,accountId:r?.id||"default",category:"",cleared:!0,notes:l,recurring:!1};if(c.autoCategorize&&c.categories){a.length>0&&t.learnFromTransactions(a,c.categories);const e=t.suggestCategories(T,1);e.length>0&&e[0].confidence>=.7&&(T.category=e[0].categoryId)}i.push(T)}return{transactions:i,matchedAccount:r,unmatchedAccount:r?void 0:s.account,duplicates:u,newTransactions:i.length}}};export{e as o};
