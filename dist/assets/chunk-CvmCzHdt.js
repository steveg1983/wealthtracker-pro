const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/chunk-BScDNWJv.js","assets/chunk-BWx9oMeS.js","assets/index-CgJz7Gw0.js","assets/chunk-BN8kgYrt.js","assets/chunk-C1eKK5Oc.js","assets/index-Bkln43Xj.css"])))=>i.map(i=>d[i]);
import{_ as t}from"./chunk-C1eKK5Oc.js";import{c0 as e,c1 as a}from"./index-CgJz7Gw0.js";const r=new class{tesseractLoaded=!1;tesseractWorker=null;async initialize(){if(!this.tesseractLoaded)try{const e=await t(()=>import("./chunk-BScDNWJv.js").then(t=>t.i),__vite__mapDeps([0,1,2,3,4,5]));this.tesseractWorker=await e.createWorker("eng"),this.tesseractWorker&&(await this.tesseractWorker.loadLanguage("eng"),await this.tesseractWorker.initialize("eng")),this.tesseractLoaded=!0}catch(e){throw console.error("Failed to initialize OCR:",e),new Error("OCR initialization failed")}}async extractTextFromImage(t){await this.initialize();try{if(!this.tesseractWorker)throw new Error("OCR worker not initialized");const{data:e}=await this.tesseractWorker.recognize(t);return{text:e.text,confidence:e.confidence/100,lines:e.lines.map(t=>t.text)}}catch(e){throw console.error("OCR extraction failed:",e),new Error("Failed to extract text from image")}}async extractDataFromDocument(t){if("application/pdf"===t.type)return this.extractDataFromPDF(t);if(t.type.startsWith("image/")){const e=URL.createObjectURL(t);try{const t=await this.extractTextFromImage(e);return{...this.parseReceiptText(t.text,t.lines),confidence:t.confidence,rawText:t.text}}finally{URL.revokeObjectURL(e)}}return{confidence:0,rawText:""}}parseReceiptText(t,e){const a={},r=[/^([A-Z][A-Za-z\s&'-]+)$/m,/(?:from|at|@)\s+([A-Za-z\s&'-]+)/i];for(const l of r){const e=t.match(l);if(e){a.merchant=e[1].trim();break}}const o=[/(\d{1,2}[-/]\d{1,2}[-/]\d{2,4})/,/(\d{1,2}\s+(?:Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)[a-z]*\s+\d{2,4})/i,/(?:Date|DATE|Date:)\s*([^\n]+)/i];for(const l of o){const e=t.match(l);if(e){const t=e[1].trim(),r=this.parseDate(t);if(r){a.date=r;break}}}const n=[/(?:Total|TOTAL|Total:)\s*[\xa3$\u20ac]?\s*(\d+[.,]\d{2})/i,/(?:Amount|AMOUNT|Amount:)\s*[\xa3$\u20ac]?\s*(\d+[.,]\d{2})/i,/(?:Grand Total|GRAND TOTAL):\s*[\xa3$\u20ac]?\s*(\d+[.,]\d{2})/i,/[\xa3$\u20ac]\s*(\d+[.,]\d{2})(?:\s|$)/g],i=[];for(const l of n){const e=t.matchAll(l instanceof RegExp&&l.global?l:new RegExp(l,"g"));for(const t of e){const e=parseFloat(t[1].replace(",","."));isNaN(e)||i.push(e)}}i.length>0&&(a.totalAmount=Math.max(...i));const s=[/(?:Tax|TAX|VAT|GST)\s*[\xa3$\u20ac]?\s*(\d+[.,]\d{2})/i,/(?:Sales Tax|SALES TAX):\s*[\xa3$\u20ac]?\s*(\d+[.,]\d{2})/i];for(const l of s){const e=t.match(l);if(e){const t=parseFloat(e[1].replace(",","."));if(!isNaN(t)){a.taxAmount=t;break}}}const c=t.match(/[\xa3$\u20ac]/);if(c)switch(c[0]){case"\xa3":a.currency="GBP";break;case"$":a.currency="USD";break;case"\u20ac":a.currency="EUR"}a.items=this.extractLineItems(e);const d=[/(?:paid by|payment method|pay by):\s*([^\n]+)/i,/(?:VISA|MASTERCARD|AMEX|CASH|DEBIT|CREDIT)(?:\s*CARD)?/i,/\*{4}\s*\d{4}/];for(const l of d){const e=t.match(l);if(e){a.paymentMethod=e[0].trim();break}}return a}extractLineItems(t){const e=[],a=/^(.+?)\s+[\xa3$\u20ac]?\s*(\d+[.,]\d{2})$/,r=/(\d+)\s*[xX@]\s*[\xa3$\u20ac]?\s*(\d+[.,]\d{2})/;for(const o of t){const t=o.match(a);if(t){const a=t[1].trim(),n=parseFloat(t[2].replace(",",".")),i=o.match(r);i?e.push({description:a.replace(i[0],"").trim(),quantity:parseInt(i[1]),unitPrice:parseFloat(i[2].replace(",",".")),totalPrice:n}):e.push({description:a,totalPrice:n})}}return e}parseDate(t){const e=[/^(\d{1,2})[-/](\d{1,2})[-/](\d{2,4})$/,/^(\d{1,2})[-/](\d{1,2})[-/](\d{2,4})$/,/^(\d{1,2})\s+([A-Za-z]+)\s+(\d{2,4})$/],a=new Date(t);if(!isNaN(a.getTime()))return a;for(const r of e){const e=t.match(r);if(e){const t=parseInt(e[1]),a=parseInt(e[2])-1,r=parseInt(e[3]),o=new Date(r<100?2e3+r:r,a,t);if(!isNaN(o.getTime()))return o}}}async extractDataFromPDF(t){return{confidence:0,rawText:"PDF extraction not yet implemented"}}async cleanup(){this.tesseractWorker&&(await this.tesseractWorker.terminate(),this.tesseractWorker=null,this.tesseractLoaded=!1)}},o=new class{initialized=!1;storageKey="wealthtracker_documents";maxFileSize=10485760;allowedMimeTypes=["image/jpeg","image/jpg","image/png","image/gif","image/webp","application/pdf","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.ms-excel","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"];constructor(){this.init()}async init(){try{await e.init(),await this.migrateDocuments(),this.initialized=!0}catch(t){console.error("Failed to initialize document service:",t)}}async migrateDocuments(){localStorage.getItem(this.storageKey)&&(await a(this.storageKey,"documents",t=>({...t,uploadDate:new Date(t.uploadDate),expiryDate:t.expiryDate?new Date(t.expiryDate):void 0,extractedData:t.extractedData?{...t.extractedData,date:t.extractedData.date?new Date(t.extractedData.date):void 0}:void 0})),await e.count("documents")>0&&localStorage.removeItem(this.storageKey))}async ensureInitialized(){this.initialized||await this.init()}async loadDocuments(){try{return await this.ensureInitialized(),await e.getAll("documents")}catch(t){console.error("Failed to load documents from IndexedDB:",t);try{const t=localStorage.getItem(this.storageKey);if(t)return JSON.parse(t).map(t=>({...t,uploadDate:new Date(t.uploadDate),expiryDate:t.expiryDate?new Date(t.expiryDate):void 0,extractedData:t.extractedData?{...t.extractedData,date:t.extractedData.date?new Date(t.extractedData.date):void 0}:void 0}))}catch(a){console.error("Failed to load documents from localStorage:",a)}return[]}}async saveDocument(t){try{await this.ensureInitialized(),await e.put("documents",t)}catch(a){throw console.error("Failed to save document to IndexedDB:",a),new Error("Failed to save document")}}async uploadDocument(t,a){try{if(t.size>this.maxFileSize)throw new Error(`File size exceeds maximum allowed size of ${this.maxFileSize/1024/1024}MB`);if(!this.allowedMimeTypes.includes(t.type))throw new Error("File type not supported");await this.ensureInitialized();const o=`doc-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,n={id:o,transactionId:a.transactionId,accountId:a.accountId,type:a.type,fileName:t.name,fileSize:t.size,mimeType:t.type,uploadDate:new Date,tags:a.tags||[],notes:a.notes,fullUrl:o,cloudProvider:"local"};if(await e.storeBlob(o,t),t.type.startsWith("image/")){const a=await this.generateThumbnailBlob(t);if(a){const t=`${o}-thumb`;await e.storeBlob(t,a),n.thumbnailUrl=t}}if(a.extractData&&(t.type.startsWith("image/")||"application/pdf"===t.type))try{n.extractedData=await this.extractDataFromDocument(t)}catch(r){console.error("OCR extraction failed:",r)}return await this.saveDocument(n),n}catch(r){throw console.error("Failed to upload document:",r),r}}async extractDataFromDocument(t){return await async function(t){try{return await r.extractDataFromDocument(t)}catch(e){return console.error("OCR failed:",e),{confidence:0,rawText:"",error:e instanceof Error?e.message:"OCR extraction failed"}}}(t)}async fileToBase64(t){return new Promise((e,a)=>{const r=new FileReader;r.readAsDataURL(t),r.onload=()=>e(r.result),r.onerror=t=>a(t)})}async generateThumbnail(t){return new Promise((e,a)=>{const r=new Image,o=document.createElement("canvas"),n=o.getContext("2d");r.onload=()=>{const t=200;let a=r.width,i=r.height;a>i?a>t&&(i=i*t/a,a=t):i>t&&(a=a*t/i,i=t),o.width=a,o.height=i,n?.drawImage(r,0,0,a,i),e(o.toDataURL("image/jpeg",.7))},r.onerror=a,r.src=URL.createObjectURL(t)})}async generateThumbnailBlob(t){return new Promise((e,a)=>{const r=new Image,o=document.createElement("canvas"),n=o.getContext("2d");r.onload=()=>{try{const t=200;let a=r.width,i=r.height;a>i?a>t&&(i=i*t/a,a=t):i>t&&(a=a*t/i,i=t),o.width=a,o.height=i,n?.drawImage(r,0,0,a,i),o.toBlob(t=>{e(t)},"image/jpeg",.7)}catch(t){a(t)}},r.onerror=()=>e(null);const i=URL.createObjectURL(t);r.src=i,r.onload=function(){URL.revokeObjectURL(i),r.onload()}})}async getDocument(t){try{return await this.ensureInitialized(),await e.get("documents",t)??null}catch(a){return console.error("Failed to get document:",a),null}}async getDocuments(t){try{await this.ensureInitialized();let a=[];a=t?.transactionId?await e.getByIndex("documents","transactionId",t.transactionId):t?.accountId?await e.getByIndex("documents","accountId",t.accountId):await this.loadDocuments();let r=[...a];if(t&&(t.type&&(r=r.filter(e=>e.type===t.type)),t.tags&&t.tags.length>0&&(r=r.filter(e=>t.tags.some(t=>e.tags.includes(t)))),t.dateFrom&&(r=r.filter(e=>e.uploadDate>=t.dateFrom)),t.dateTo&&(r=r.filter(e=>e.uploadDate<=t.dateTo)),t.searchTerm)){const e=t.searchTerm.toLowerCase();r=r.filter(t=>t.fileName.toLowerCase().includes(e)||t.notes?.toLowerCase().includes(e)||t.extractedData?.merchant?.toLowerCase().includes(e)||t.extractedData?.rawText?.toLowerCase().includes(e))}return r.sort((t,e)=>e.uploadDate.getTime()-t.uploadDate.getTime())}catch(a){return console.error("Failed to get documents:",a),[]}}async updateDocument(t,e){try{await this.ensureInitialized();const a=await this.getDocument(t);if(!a)return!1;const r={...a,...e,id:a.id};return await this.saveDocument(r),!0}catch(a){return console.error("Failed to update document:",a),!1}}async deleteDocument(t){try{return await this.ensureInitialized(),await e.delete("documents",t),await e.delete("documentBlobs",t),await e.delete("documentBlobs",`${t}-thumb`),!0}catch(a){return console.error("Failed to delete document:",a),!1}}async getTransactionDocuments(t){return await this.getDocuments({transactionId:t})}async getAccountDocuments(t){return await this.getDocuments({accountId:t})}async getDocumentBlob(t){try{return await this.ensureInitialized(),await e.getBlob(t)}catch(a){return void console.error("Failed to get document blob:",a)}}async getDocumentUrl(t){try{const e=await this.getDocumentBlob(t);return e?URL.createObjectURL(e):null}catch(e){return console.error("Failed to get document URL:",e),null}}async getStorageStats(){try{await this.ensureInitialized();const t=await this.loadDocuments(),a=t.reduce((t,e)=>t+e.fileSize,0),r=t.reduce((t,e)=>(t[e.type]=(t[e.type]||0)+1,t),{}),o=await e.getStorageInfo();return{totalDocuments:t.length,totalSize:a,totalSizeMB:Math.round(a/1024/1024*100)/100,byType:r,oldestDocument:t.length>0?new Date(Math.min(...t.map(t=>t.uploadDate.getTime()))):null,indexedDBUsage:o.usage,indexedDBQuota:o.quota,usagePercentage:o.quota>0?o.usage/o.quota*100:0}}catch(t){return console.error("Failed to get storage stats:",t),{totalDocuments:0,totalSize:0,totalSizeMB:0,byType:{},oldestDocument:null,indexedDBUsage:0,indexedDBQuota:0,usagePercentage:0}}}async exportMetadata(){try{const t=(await this.loadDocuments()).map(({fullUrl:t,thumbnailUrl:e,...a})=>a);return JSON.stringify(t,null,2)}catch(t){return console.error("Failed to export metadata:",t),"[]"}}async cleanupOldDocuments(t=365){try{await this.ensureInitialized();const a=new Date;a.setDate(a.getDate()-t);const r=(await this.loadDocuments()).filter(t=>t.uploadDate<=a);for(const t of r)await this.deleteDocument(t.id);return await e.cleanCache(),r.length}catch(a){return console.error("Failed to cleanup old documents:",a),0}}async searchByExtractedData(t){try{const e=await this.loadDocuments(),a=t.toLowerCase();return e.filter(t=>!!t.extractedData&&(t.extractedData.merchant?.toLowerCase().includes(a)||t.extractedData.items?.some(t=>t.description.toLowerCase().includes(a))||t.extractedData.rawText?.toLowerCase().includes(a)))}catch(e){return console.error("Failed to search documents:",e),[]}}async getExpiringDocuments(t=30){try{const e=await this.loadDocuments(),a=new Date;return a.setDate(a.getDate()+t),e.filter(t=>t.expiryDate&&t.expiryDate<=a&&t.expiryDate>=new Date)}catch(e){return console.error("Failed to get expiring documents:",e),[]}}};export{o as d};
