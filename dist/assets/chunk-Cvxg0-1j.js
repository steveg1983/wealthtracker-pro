const e="security_settings",t="audit_logs",r="biometric_credentials",i=new class{settings;auditLogs=[];constructor(){this.settings=this.loadSettings(),this.auditLogs=this.loadAuditLogs()}loadSettings(){const t=localStorage.getItem(e);return t?JSON.parse(t):{twoFactorEnabled:!1,biometricEnabled:!1,readOnlyMode:!1,encryptionEnabled:!1,sessionTimeout:30,failedAttempts:0}}saveSettings(){localStorage.setItem(e,JSON.stringify(this.settings))}getSecuritySettings(){return{...this.settings}}updateSecuritySettings(e){const t={...this.settings};this.settings={...this.settings,...e},this.saveSettings();const r={};Object.keys(e).forEach(i=>{i in e&&(r[i]={old:t[i],new:e[i]})}),this.logAction("update","settings","security",r)}generateTwoFactorSecret(){const e=this.generateRandomString(32),t="WealthTracker";return{secret:e,qrCode:`otpauth://totp/${t}:user@example.com?secret=${e}&issuer=${t}`,backupCodes:Array.from({length:10},()=>this.generateRandomString(8).toUpperCase())}}verifyTwoFactorCode(e,t){return e===this.generateTOTPCode(t)}generateTOTPCode(e){const t=Math.floor(Date.now()/3e4);return String(Math.abs(this.hashCode(e+t))%1e6).padStart(6,"0")}hashCode(e){let t=0;for(let r=0;r<e.length;r++)t=(t<<5)-t+e.charCodeAt(r),t&=t;return t}async setupBiometric(){if(!this.isBiometricAvailable())throw new Error("Biometric authentication not available");try{if(!window.PublicKeyCredential)throw new Error("WebAuthn not supported");const e=new Uint8Array(32);crypto.getRandomValues(e);const t={publicKey:{challenge:e,rp:{name:"Wealth Tracker",id:window.location.hostname},user:{id:(new TextEncoder).encode("user-id"),name:"user@example.com",displayName:"User"},pubKeyCredParams:[{alg:-7,type:"public-key"},{alg:-257,type:"public-key"}],authenticatorSelection:{authenticatorAttachment:"platform",userVerification:"required"},timeout:6e4,attestation:"direct"}},r=await navigator.credentials.create(t);if(r){const e={credentialId:this.arrayBufferToBase64(r.rawId),publicKey:"mock-public-key",counter:0,createdAt:new Date};return this.saveBiometricCredential(e),e}}catch(e){console.error("Biometric setup failed:",e)}return null}async verifyBiometric(){if(!this.isBiometricAvailable())return!1;try{const e=this.loadBiometricCredentials();if(0===e.length)return!1;const t=new Uint8Array(32);crypto.getRandomValues(t);const r={publicKey:{challenge:t,allowCredentials:e.map(e=>({id:this.base64ToArrayBuffer(e.credentialId),type:"public-key"})),userVerification:"required",timeout:6e4}};return null!==await navigator.credentials.get(r)}catch(e){return console.error("Biometric verification failed:",e),!1}}async isBiometricAvailable(){if(!window.PublicKeyCredential)return!1;if(PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable)try{return await PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable()}catch{return!1}return!1}saveBiometricCredential(e){const t=this.loadBiometricCredentials();t.push(e),localStorage.setItem(r,JSON.stringify(t))}loadBiometricCredentials(){const e=localStorage.getItem(r);return e?JSON.parse(e):[]}async encryptData(e){if(!this.settings.encryptionEnabled)return e;try{const t=(new TextEncoder).encode(e),r=await this.getEncryptionKey(),i=crypto.getRandomValues(new Uint8Array(12)),s=await crypto.subtle.encrypt({name:"AES-GCM",iv:i},r,t),n=new Uint8Array(i.length+s.byteLength);return n.set(i),n.set(new Uint8Array(s),i.length),this.arrayBufferToBase64(n.buffer)}catch(t){return console.error("Encryption failed:",t),e}}async decryptData(e){if(!this.settings.encryptionEnabled)return e;try{const t=this.base64ToArrayBuffer(e),r=new Uint8Array(t),i=r.slice(0,12),s=r.slice(12),n=await this.getEncryptionKey(),a=await crypto.subtle.decrypt({name:"AES-GCM",iv:i},n,s);return(new TextDecoder).decode(a)}catch(t){return console.error("Decryption failed:",t),e}}async getEncryptionKey(){const e=await crypto.subtle.importKey("raw",(new TextEncoder).encode("temporary-encryption-key-32bytes"),"PBKDF2",!1,["deriveKey"]);return crypto.subtle.deriveKey({name:"PBKDF2",salt:(new TextEncoder).encode("wealth-tracker-salt"),iterations:1e5,hash:"SHA-256"},e,{name:"AES-GCM",length:256},!1,["encrypt","decrypt"])}isReadOnlyMode(){return this.settings.readOnlyMode}toggleReadOnlyMode(e){const t=this.settings.readOnlyMode;this.settings.readOnlyMode=e,this.saveSettings();const r={readOnlyMode:{old:t,new:e}};this.logAction("update","settings","read-only-mode",r)}loadAuditLogs(){const e=localStorage.getItem(t);return e?JSON.parse(e).map(e=>({...e,timestamp:new Date(e.timestamp)})):[]}saveAuditLogs(){const e=this.auditLogs.slice(-1e3);localStorage.setItem(t,JSON.stringify(e))}logAction(e,t,r,i){const s={id:this.generateRandomString(16),timestamp:new Date,userId:"current-user",action:e,resourceType:t,resourceId:r,changes:i,ipAddress:"localhost",userAgent:navigator.userAgent};this.auditLogs.push(s),this.saveAuditLogs()}getAuditLogs(e){let t=[...this.auditLogs];return e&&(e.startDate&&(t=t.filter(t=>t.timestamp>=e.startDate)),e.endDate&&(t=t.filter(t=>t.timestamp<=e.endDate)),e.action&&(t=t.filter(t=>t.action===e.action)),e.resourceType&&(t=t.filter(t=>t.resourceType===e.resourceType))),t.sort((e,t)=>t.timestamp.getTime()-e.timestamp.getTime())}checkSession(){return!!this.settings.lastLogin&&Date.now()-this.settings.lastLogin.getTime()<60*this.settings.sessionTimeout*1e3}updateLastActivity(){this.settings.lastLogin=new Date,this.saveSettings()}recordFailedAttempt(){this.settings.failedAttempts++,this.settings.failedAttempts>=5&&(this.settings.lockedUntil=new Date(Date.now()+18e5)),this.saveSettings()}resetFailedAttempts(){this.settings.failedAttempts=0,this.settings.lockedUntil=void 0,this.saveSettings()}isAccountLocked(){return!(!this.settings.lockedUntil||new Date>this.settings.lockedUntil&&(this.resetFailedAttempts(),1))}generateRandomString(e){let t="";const r=new Uint8Array(e);crypto.getRandomValues(r);for(let i=0;i<e;i++)t+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789"[r[i]%62];return t}arrayBufferToBase64(e){const t=new Uint8Array(e);let r="";for(let i=0;i<t.byteLength;i++)r+=String.fromCharCode(t[i]);return btoa(r)}base64ToArrayBuffer(e){const t=atob(e),r=new Uint8Array(t.length);for(let i=0;i<t.length;i++)r[i]=t.charCodeAt(i);return r.buffer}};export{i as s};
