const t=new class{patterns=new Map;merchantCategoryMap=new Map;keywordCategoryMap=new Map;learningHistory=new Map;userCorrections=new Map;rejectedSuggestions=new Map;learnFromTransactions(t,e){this.patterns.clear(),this.merchantCategoryMap.clear(),this.keywordCategoryMap.clear();const o=new Map;t.forEach(t=>{if(t.category){const e=o.get(t.category)||[];e.push(t),o.set(t.category,e)}}),o.forEach((t,e)=>{const o=this.buildCategoryPattern(e,t);this.patterns.set(e,o),t.forEach(t=>{const o=this.extractMerchant(t.description);if(o){const t=this.merchantCategoryMap.get(o)||[],n=t.find(t=>t.categoryId===e);n?n.count++:t.push({categoryId:e,count:1}),this.merchantCategoryMap.set(o,t)}}),this.extractKeywords(t).forEach(t=>{const o=this.keywordCategoryMap.get(t)||[],n=o.find(t=>t.categoryId===e);n?n.count++:o.push({categoryId:e,count:1}),this.keywordCategoryMap.set(t,o)})})}suggestCategories(t,e=3){const o=[],n=this.extractMerchant(t.description),r=t.description.toLowerCase();if(n){const t=this.merchantCategoryMap.get(n);t&&t.sort((t,e)=>e.count-t.count).slice(0,2).forEach(t=>{o.push({categoryId:t.categoryId,confidence:Math.min(.9,.7+.02*t.count),reason:`Merchant "${n}" frequently categorized here`})})}const a=r.split(/\s+/),s=new Map;return a.forEach(t=>{if(t.length>3){const e=this.keywordCategoryMap.get(t);e&&e.forEach(t=>{const e=s.get(t.categoryId)||0;s.set(t.categoryId,e+t.count)})}}),Array.from(s.entries()).sort((t,e)=>e[1]-t[1]).slice(0,2).forEach(([t,e])=>{o.find(e=>e.categoryId===t)||o.push({categoryId:t,confidence:Math.min(.7,.4+.05*e),reason:"Keywords match previous transactions"})}),this.patterns.forEach((e,n)=>{if(!o.find(t=>t.categoryId===n)){let a=0,s=0;if(e.amountRanges&&e.amountRanges.length>0){const o=Math.abs(t.amount);e.amountRanges.some(t=>{const e=t.min||0,n=t.max||1/0;return o>=e&&o<=n})&&(a+=.2,s++)}e.keywords.some(t=>r.includes(t))&&(a+=.3,s++),s>0&&a>.3&&o.push({categoryId:n,confidence:Math.min(a,.6),reason:"Matches category patterns"})}}),o.sort((t,e)=>e.confidence-t.confidence).slice(0,e)}autoCategorize(t,e=.8){const o=[];return t.forEach(t=>{if(!t.category){const n=this.suggestCategories(t,1);n.length>0&&n[0].confidence>=e&&o.push({transaction:t,categoryId:n[0].categoryId,confidence:n[0].confidence})}}),o}buildCategoryPattern(t,e){const o=new Set,n=new Set,r=e.map(t=>Math.abs(t.amount));e.forEach(t=>{const e=this.extractMerchant(t.description);e&&o.add(e)});const a=e.flatMap(t=>t.description.toLowerCase().split(/\s+/)).filter(t=>t.length>3),s=new Map;a.forEach(t=>{s.set(t,(s.get(t)||0)+1)});const c=.2*e.length;s.forEach((t,e)=>{t>=c&&n.add(e)});const i=[];if(r.length>0){r.sort((t,e)=>t-e);const t=r[Math.floor(.25*r.length)],e=r[Math.floor(.75*r.length)],o=e-t;i.push({min:Math.max(0,t-1.5*o),max:e+1.5*o})}return{categoryId:t,keywords:Array.from(n),merchants:Array.from(o),amountRanges:i,confidence:Math.min(.9,.5+.01*e.length)}}extractMerchant(t){const e=t.replace(/^(CARD PURCHASE|DIRECT DEBIT|STANDING ORDER|BANK TRANSFER|POS|CONTACTLESS|ONLINE)[\s-]*/i,"").replace(/^(TO|FROM)[\s-]*/i,"").trim().split(/[\s-]/);return e.length>0&&e.slice(0,Math.min(3,e.length)).filter(t=>t.length>2).join(" ").toLowerCase()||null}extractKeywords(t){const e=new Map;return t.forEach(t=>{t.description.toLowerCase().split(/\s+/).filter(t=>t.length>3&&!this.isCommonWord(t)).forEach(t=>{e.set(t,(e.get(t)||0)+1)})}),Array.from(e.entries()).filter(([t,e])=>e>1).sort((t,e)=>e[1]-t[1]).slice(0,20).map(([t])=>t)}isCommonWord(t){return new Set(["card","purchase","payment","direct","debit","transfer","bank","online","contactless","from","with","the","and","for","pos","gbp","ref","trans","transaction"]).has(t)}learnFromCategorization(t,e){const o=this.extractMerchant(t.description),n=t.description.toLowerCase().split(/\s+/).filter(t=>t.length>3);if(o){const t=this.merchantCategoryMap.get(o)||[],n=t.find(t=>t.categoryId===e);n?n.count++:t.push({categoryId:e,count:1}),this.merchantCategoryMap.set(o,t)}n.forEach(t=>{if(!this.isCommonWord(t)){const o=this.keywordCategoryMap.get(t)||[],n=o.find(t=>t.categoryId===e);n?n.count++:o.push({categoryId:e,count:1}),this.keywordCategoryMap.set(t,o)}});const r=this.patterns.get(e);if(r){const e=Math.abs(t.amount);if(r.amountRanges&&r.amountRanges.length>0){const t=r.amountRanges[0];t.min&&e<t.min&&(t.min=.9*e),t.max&&e>t.max&&(t.max=1.1*e)}o&&!r.merchants.includes(o)&&r.merchants.push(o),n.forEach(t=>{this.isCommonWord(t)||r.keywords.includes(t)||r.keywords.push(t)}),r.confidence=Math.min(.95,r.confidence+.01)}else this.patterns.set(e,{categoryId:e,keywords:n.filter(t=>!this.isCommonWord(t)),merchants:o?[o]:[],amountRanges:[{min:.8*Math.abs(t.amount),max:1.2*Math.abs(t.amount)}],confidence:.6})}getStats(){return{patternsLearned:this.patterns.size,merchantsKnown:this.merchantCategoryMap.size,keywordsIdentified:this.keywordCategoryMap.size}}learnFromCorrection(t,e){const o=this.extractMerchant(t.description);if(o){this.userCorrections.has(o)||this.userCorrections.set(o,new Map);const t=this.userCorrections.get(o),n=t.get(e)||0;t.set(e,n+1);const r=this.merchantCategoryMap.get(o)||[],a=r.find(t=>t.categoryId===e);a?a.count+=3:r.push({categoryId:e,count:3}),this.merchantCategoryMap.set(o,r)}t.description.toLowerCase().split(/\s+/).forEach(t=>{if(t.length>3){const o=this.keywordCategoryMap.get(t)||[],n=o.find(t=>t.categoryId===e);n?n.count+=2:o.push({categoryId:e,count:2}),this.keywordCategoryMap.set(t,o)}})}learnFromRejection(t,e){const o=t.description.toLowerCase();this.rejectedSuggestions.has(o)||this.rejectedSuggestions.set(o,new Set),this.rejectedSuggestions.get(o).add(e);const n=this.extractMerchant(t.description);if(n){const t=this.merchantCategoryMap.get(n);if(t){const o=t.find(t=>t.categoryId===e);o&&o.count>0&&(o.count=Math.max(0,o.count-1))}}}wasRejected(t,e){const o=t.description.toLowerCase(),n=this.rejectedSuggestions.get(o);return!!n&&n.has(e)}};export{t as s};
